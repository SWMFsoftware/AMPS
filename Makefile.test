# Makefile for AMPS stand-alone nightly tests
# for each test a separate folder run_test_<NAME> is created 
# and executables are copied there

TESTAPPS=Mars Titan Moon
TESTAPP=
TESTAPPDIR = run_test_$(TESTAPP)

test_help:
	@echo "    test_all                 (run all tests with ${MPIRUN})"
	@echo "    test_all MPIRUN=         (run all tests with serially)"
	@echo "    test_app TESTAPP=NAME    (run application NAME test with ${MPIRUN})"

test_all:
	@rm -f *.diff
	-@$(foreach TESTAPP,$(TESTAPPS),$(MAKE) test_app TESTAPP=$(TESTAPP);)

test_compile:
	@rm -rf *.diff
	-@$(foreach TESTAPP,$(TESTAPPS),                        \
		    $(MAKE) test_app_compile TESTAPP=$(TESTAPP);\
		    $(MAKE) test_app_rundir  TESTAPP=$(TESTAPP);)

test_run:
	-@$(foreach TESTAPP,$(TESTAPPS),                      \
		    $(MAKE) test_app_run   TESTAPP=$(TESTAPP);\
		    $(MAKE) test_app_check TESTAPP=$(TESTAPP);)

test_app:
ifneq ($(TESTAPP),)
	$(MAKE) test_app_compile
	$(MAKE) test_app_rundir
	$(MAKE) test_app_run
	$(MAKE) test_app_check
else
	@echo "Application name TESTAPP is empty, specify it as \n\tmake test_app TESTAPP=NAME"
endif

test_app_compile:
ifneq ($(TESTAPP),)
	@echo "test_$(TESTAPP)_compile..." > test_$(TESTAPP).diff
	./Config.pl -application=$(TESTAPP) -spice-path=nospice -spice-kernels=nospice -model-data-path=$(MYDIR)/data/input/$(TESTAPP)  -amps-test=on 
	rm -rf srcTemp
	./ampsConfig.pl -no-compile
	$(MAKE) amps
else
	@echo "Application test name TESTAPP is empty, specify it as \n\tmake test_app_compile TESTAPP=NAME"
endif


test_app_rundir:
ifneq ($(TESTAPP),)
	@echo "test_$(TESTAPP)_rundir..." >> test_$(TESTAPP).diff
	rm -rf   ${TESTAPPDIR}
	mkdir -p ${TESTAPPDIR}
	mv amps  ${TESTAPPDIR}
else
	@echo "Application test name TESTAPP is empty, specify it as \n\tmake test_app_rundir TESTAPP=NAME"
endif

test_app_run:
ifneq ($(TESTAPP),)
	@echo "test_$(TESTAPP)_run..." >> test_$(TESTAPP).diff
	cd ${TESTAPPDIR}; ${MPIRUN} ./amps
else
	@echo "Application test name TESTAPP is empty, specify it as \n\tmake test_app_run TESTAPP=NAME"
endif

test_app_check:
ifneq ($(TESTAPP),)
	@echo "test_$(TESTAPP)_check..." >> test_$(TESTAPP).diff
	-(${SCRIPTDIR}/DiffNum.pl ${TESTAPPDIR}/PT/plots/amps.dat \
	output/test_$(TESTAPP).ref_np`ls ${TESTAPPDIR}/PT/thread* | wc -l | tr -d ' '` \
	> test_$(TESTAPP).diff)
	@ls -l test_$(TESTAPP).diff
else
	@echo "Application test name TESTAPP is empty, specify it as \n\tmake test_app_check TESTAPP=NAME"
endif
